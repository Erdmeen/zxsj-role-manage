<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>诛仙世界角色周任务记录</title>
    <script src="./vue.global.js"></script>
    <style>
      /* 基础样式 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      html,
      body {
        height: 100%;
        overflow: hidden;
      }

      body {
        color: rgba(0, 0, 0, 0.85);
        padding: 0;
        font-size: 14px;
        line-height: 1.5715;
        display: flex;
        flex-direction: column;
        overflow-x: auto;
      }

      .container {
        width: 100%;
        min-width: 1057px;
        margin: 0 auto;
        background-color: #fff;
        border-radius: 2px;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
        padding: 16px;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: auto;
        gap: 5px;
      }

      /* 按钮统一样式 */
      .btn {
        height: 36px;
        padding: 6px 16px;
        border: 1px solid transparent;
        border-radius: 2px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.12);
        box-shadow: 0 2px 0 rgba(0, 0, 0, 0.045);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #1890ff;
        color: #fff;
        margin-right: 12px;
        min-width: 88px;
      }

      .btn:last-child {
        margin-right: 0;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* 编辑按钮样式 */
      .btn-edit {
        background: #1890ff;
        border-color: #1890ff;
      }

      .btn-success {
        background: #52c41a;
        border-color: #52c41a;
      }

      .btn-danger {
        background: #ff4d4f;
        border-color: #ff4d4f;
      }

      /* 小型按钮样式 */
      .category-header .btn-sm {
        padding: 4px 12px;
        font-size: 12px;
        border: 1px solid #1890ff;
        border-radius: 2px;
        background: #1890ff;
        cursor: pointer;
        transition: all 0.3s;
      }

      /* 卡片布局优化 */
      .module-container {
        border-radius: 2px;
        padding: 16px;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
        transition: all 0.3s;
        border: 1px solid #f0f0f0;
        background: #fff;
        margin-bottom: 0;
      }

      .module-container:hover {
        box-shadow: 0 3px 6px -4px rgba(0, 0, 0, 0.12),
          0 6px 16px 0 rgba(0, 0, 0, 0.08), 0 9px 28px 8px rgba(0, 0, 0, 0.05);
      }

      .role-list .module-title {
        font-size: 16px;
        color: rgba(0, 0, 0, 0.85);
        font-weight: 500;
        line-height: 24px;
        height: 24px;
      }

      .role-item {
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 2px;
        cursor: pointer;
        transition: all 0.3s;
        background-color: #fafafa;
        border: 1px solid #f0f0f0;
      }

      .role-item:last-child {
        margin-bottom: 0;
      }

      .role-item:hover {
        background-color: #f5f5f5;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.09);
      }

      .role-item.active {
        background-color: #e6f7ff;
        border-color: #91d5ff;
      }

      .role-content {
        flex: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .role-content .module-container {
        margin-bottom: 20px;
        /* 添加底部间距 */
      }

      .role-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        border-bottom: 1px solid #f0f0f0;
        background-color: #fafafa;
      }

      .role-header-buttons {
        display: flex;
        gap: 8px;
      }

      .role-name-container {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: space-between;
      }

      .role-name {
        font-size: 14px;
        color: rgba(0, 0, 0, 0.85);
        margin: 0;
        line-height: 1.4;
        font-weight: 500;
      }

      .role-description {
        color: #666;
        font-size: 14px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        word-wrap: break-word;
        word-break: break-all;
        max-width: 100%;
        width: 100%;
        margin-top: 4px;
        background-color: #f5f5f5;
        border-radius: 2px;
      }

      .profession-tag {
        padding: 2px 8px;
        font-size: 12px;
        border-radius: 2px;
        color: #fff;
        font-weight: 500;
        line-height: 1.4;
      }

      /* 标签统一样式 */
      .profession-tag,
      .dungeon-tag,
      .dungeon-size,
      .task-type-tag {
        display: inline-flex;
        align-items: center;
        height: 24px;
        padding: 0 8px;
        font-size: 12px;
        line-height: 24px;
        border-radius: 2px;
        color: #fff;
        font-weight: 500;
        white-space: nowrap;
      }

      /* 职业标签样式 */
      .profession-tag.ghost-king {
        background: #ff4d4f;
      }

      .profession-tag.spirit-tide {
        background: #52c41a;
      }

      .profession-tag.blue-cloud {
        background: #1890ff;
      }

      .profession-tag.harmony {
        background: #722ed1;
      }

      .profession-tag.incense {
        background: #fa8c16;
      }

      /* 副本标签样式 */
      .dungeon-tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 2px;
        font-size: 12px;
        margin-left: 8px;
        color: #fff;
        line-height: 1.5;
      }

      .dungeon-tag.hard {
        background-color: #1890ff;
      }

      .dungeon-tag.nightmare {
        background-color: #ff4d4f;
      }

      /* 副本规模标签样式 */
      .dungeon-size.small {
        background: #52c41a;
      }

      .dungeon-size.medium {
        background: #1890ff;
      }

      .dungeon-size.large {
        background: #722ed1;
      }

      /* 任务类型标签样式 */
      .task-type-tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 2px;
        font-size: 12px;
        line-height: 20px;
        color: #fff;
        margin-right: 8px;
      }

      /* 副本任务 */
      .task-type-tag.dungeon {
        background-color: #ff4d4f;
      }

      /* 帮派任务 */
      .task-type-tag.guild {
        background-color: #fa8c16;
      }

      /* 世界任务 */
      .task-type-tag.world {
        background-color: #efe409;
      }

      /* 其他任务 */
      .task-type-tag.other {
        background-color: #52c41a;
      }

      /* 活力任务 */
      .task-type-tag.vitality {
        background-color: #00c1ab;
      }

      /* 活动任务 */
      .task-type-tag.activity {
        background-color: #1890ff;
      }

      /* 自定义任务 */
      .task-type-tag.custom {
        background-color: #722ed1;
      }

      

      .task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 8px;
        background: #fff;
        border: 1px solid #f0f0f0;
        border-radius: 2px;
        transition: all 0.3s;
        min-height: 40px;
        width: 100%;
      }

      .task-item:last-child {
        margin-bottom: 0;
      }

      .task-item:hover {
        background: #fafafa;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.09);
      }

      .task-item.completed {
        background: #f6ffed;
        border-color: #b7eb8f;
        opacity: 0.8;
      }

      .task-checkbox {
        margin-right: 12px;
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .task-content {
        display: flex;
        align-items: center;
        flex: 1;
        min-width: 0;
        margin-right: 8px;
        overflow: hidden;
      }

      .task-name {
        margin: 0 8px;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .task-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .task-item:hover .task-actions {
        opacity: 1;
      }

      .task-actions .btn {
        height: 28px;
        min-width: 60px;
        padding: 0 12px;
        font-size: 12px;
      }

      /* 空状态样式 */
      .empty-state {
        text-align: center;
        padding: 32px 0;
        color: rgba(0, 0, 0, 0.25);
        background: #fafafa;
        border-radius: 2px;
        border: 1px dashed #f0f0f0;
      }

      /* 移动端导航按钮 */
      .mobile-nav-toggle {
        display: none;
        width: 100%;
        height: 40px;
        padding: 0 16px;
        background: #fff;
        color: #1890ff;
        border: 1px solid #1890ff;
        border-radius: 2px;
        margin-bottom: 16px;
        font-weight: 400;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.645, 0.045, 0.355, 1);
      }

      .mobile-nav-toggle:hover {
        color: #40a9ff;
        border-color: #40a9ff;
        background: #fff;
      }

      /* 银两显示样式优化 */
      .silver-display {
        display: flex;
        align-items: center;
        height: 36px;
        padding: 0;
      }

      .silver-left {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .silver-icon {
        color: #faad14;
        font-size: 14px;
      }

      .silver-amount {
        color: #faad14;
        font-weight: 500;
        font-size: 14px;
      }

      .silver-unit {
        font-size: 12px;
        color: rgba(0, 0, 0, 0.45);
        margin-left: 2px;
      }

      /* 银两编辑容器样式 */
      .silver-edit-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .silver-edit-input {
        width: 80px;
        height: 32px;
        padding: 4px 8px;
        border: 1px solid #d9d9d9;
        border-radius: 2px;
        font-size: 14px;
      }

      /* 角色列表中的银两显示 */
      .role-item .silver-display {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 24px;
      }

      .role-item .silver-icon {
        font-size: 14px;
      }

      .role-item .silver-amount {
        color: #faad14;
        font-weight: 500;
        font-size: 14px;
      }

      .role-item .silver-unit {
        font-size: 12px;
        color: rgba(0, 0, 0, 0.45);
        margin-left: 2px;
      }

      .role-item .silver-right {
        display: flex;
        align-items: center;
      }

      /* 进度条样式优化 */
      .role-progress-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 24px;
      }

      .role-progress-bar {
        flex: 1;
        height: 6px;
        background-color: #f0f0f0;
        border-radius: 2px;
        overflow: hidden;
        position: relative;
      }

      .progress-value {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background: linear-gradient(90deg, #1890ff 0%, #40a9ff 100%);
        box-shadow: 0 0 10px rgba(24, 144, 255, 0.8);
        border-radius: 2px;
        transition: width 0.3s ease;
      }

      .progress-value.completed {
        background-color: #52c41a;
        /* 使用绿色表示完成 */
        box-shadow: 0 0 8px rgba(82, 196, 26, 0.5);
        /* 添加发光效果 */
      }

      .role-progress-value {
        font-size: 12px;
        color: #1890ff;
        font-weight: 500;
        min-width: 40px;
        text-align: right;
      }

      .role-progress-value.completed-text {
        color: #52c41a;
        font-weight: 600;
      }

      /* 标题容器样式 */
      .title-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .title-left {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .title-left h1 {
        font-size: 24px;
        margin: 0;
        color: rgba(0, 0, 0, 0.85);
        font-weight: 600;
        line-height: 1.4;
      }

      .title-left p {
        margin: 0;
        font-size: 13px;
        color: rgba(0, 0, 0, 0.45);
        line-height: 1.6;
        max-width: 580px;
      }

      .title-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .btn-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .btn-group .btn {
        margin: 0;
      }

      .reset-info {
        font-size: 13px;
        color: rgba(0, 0, 0, 0.65);
        line-height: 1.4;
      }

      .reset-info p {
        margin: 0;
      }

      .reset-time {
        color: #1890ff;
        font-weight: 500;
      }

      .reset-days {
        color: #ff4d4f;
        font-weight: 500;
      }

      /* 职业选择样式 */
      .profession-selection {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 8px 0;
      }

      .profession-option {
        cursor: pointer;
        padding: 4px;
        border-radius: 2px;
        transition: all 0.3s;
        position: relative;
      }

      .profession-option:hover {
        transform: translateY(-2px);
      }

      .profession-option.selected {
        background: rgba(24, 144, 255, 0.1);
      }

      .profession-option.selected::after {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border: 2px solid #1890ff;
        border-radius: 2px;
        pointer-events: none;
      }

      .profession-option.selected .profession-tag {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .profession-option:hover .profession-tag {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .form-control-wrapper {
        position: relative;
      }

      .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d9d9d9;
        border-radius: 2px;
        font-size: 14px;
        line-height: 1.5;
        transition: all 0.3s;
        height: 32px;
        box-sizing: border-box;
      }

      .form-control:hover {
        border-color: #40a9ff;
      }

      .form-control:focus {
        border-color: #40a9ff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
      }

      textarea.form-control {
        resize: vertical;
        min-height: 100px;
        height: auto;
      }

      .form-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 16px;
      }

      /* 角色表单左右布局样式 */
      .role-form-container {
        display: flex;
        gap: 20px;
      }

      .role-form-left {
        flex: 1;
      }

      .role-form-right {
        display: none;
        flex: 1;
      }

      /* 表单标签和输入框左右布局 */
      .form-group-horizontal {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
      }

      .form-group-horizontal label {
        width: 100px;
        flex-shrink: 0;
        margin-bottom: 0;
        margin-right: 16px;
        line-height: 32px;
      }

      .form-group-horizontal .form-control-wrapper {
        flex: 1;
      }

      .role-info-container {
        flex: 1;
      }

      .role-name-description {
        flex: 2;
        text-align: right;
        padding-right: 20px;
      }

      /* 表单头部样式 */
      .role-form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .role-form-header .form-buttons {
        margin-top: 0;
      }

      /* 标题统一样式 */
      h1,
      h2,
      h3,
      h4 {
        margin: 0;
        padding: 0;
        font-weight: 500;
        color: rgba(0, 0, 0, 0.85);
      }

      h1 {
        font-size: 20px;
        line-height: 28px;
      }

      h2 {
        font-size: 18px;
        line-height: 26px;
      }

      h3 {
        font-size: 16px;
        line-height: 24px;
      }

      h4 {
        font-size: 14px;
        line-height: 22px;
      }

      .module-title {
        font-size: 16px;
        line-height: 36px;
        color: rgba(0, 0, 0, 0.85);
        font-weight: 500;
        height: 36px;
      }

      .category-header h4.module-title {
        margin-bottom: 10px;
      }

      /* 任务类别样式 */
      .task-categories {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .task-category {
        min-width: 240px;
        max-width: 240px;
        flex: 1 0 240px;
        padding: 10px;
        background: #fff;
        border: 1px solid #f0f0f0;
        border-radius: 2px;
        display: flex;
        flex-direction: column;
      }

      .category-items {
        max-height: 180px;
        min-height: 180px;
        overflow-y: auto;
        border-radius: 2px;
        flex: 1;
      }

      /* 滚动条样式优化 */
      .task-categories::-webkit-scrollbar {
        height: 6px;
      }

      .task-categories::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
      }

      .task-categories::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 2px;
      }

      .task-categories::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .category-header .btn-sm {
        padding: 4px 12px;
        font-size: 12px;
        border: 1px solid #d9d9d9;
        border-radius: 2px;
        background: #fff;
        cursor: pointer;
        transition: all 0.3s;
      }

      /* 副本任务样式 */
      .dungeon-group {
        background: #fff;
        border: 1px solid #f0f0f0;
        border-radius: 2px;
        padding: 12px;
      }

      .dungeon-group:last-child {
        margin-bottom: 0;
      }

      .dungeon-group-header {
        padding-bottom: 8px;
      }

      .dungeon-task-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .dungeon-task-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        background: #fff;
        border: 1px solid #f0f0f0;
        border-radius: 2px;
        transition: all 0.3s;
        cursor: pointer;
      }

      .dungeon-task-item:hover {
        background: #f5f5f5;
      }

      .dungeon-task-item input[type="checkbox"] {
        margin-right: 12px;
      }

      .dungeon-task-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex: 1;
      }

      .dungeon-task-content span:first-child {
        color: rgba(0, 0, 0, 0.85);
        font-size: 14px;
      }

      /* 预定义任务项样式 */
      .predefined-task-item {
        display: flex;
        align-items: center;
        height: 40px;
        padding: 0 12px;
        margin-bottom: 8px;
        background: #fff;
        border: 1px solid #f0f0f0;
        border-radius: 2px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .predefined-task-item:last-child {
        margin-bottom: 0;
      }

      .predefined-task-item:hover {
        background: #f5f5f5;
        border-color: #d9d9d9;
      }

      .predefined-task-item input[type="checkbox"] {
        margin-right: 12px;
      }

      /* 滚动条样式 */
      .category-items::-webkit-scrollbar {
        width: 6px;
      }

      .category-items::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
      }

      .category-items::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 2px;
      }

      .category-items::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      /* 角色区域布局样式 */
      .role-section {
        display: flex;
        gap: 5px;
        height: calc(100vh - 100px);
        overflow: hidden;
      }

      .role-list.module-container {
        width: 300px;
        height: 100%;
        overflow-y: auto;
        flex-shrink: 0;
      }

      .role-content {
        flex: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .role-content .module-container {
        margin-bottom: 0;
      }

      .role-header.module-container {
        flex-shrink: 0;
      }

      .task-list.module-container {
        flex: 1;
        overflow-y: auto;
        display: block;
        /* 修改这里，默认显示 */
        margin-bottom: 0;
      }

      /* 当显示表单时隐藏任务列表 */
      .show-task-form .task-list.module-container {
        display: none;
      }

      .task-list .task-item {
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .task-list .task-item:hover {
        background-color: rgba(0, 0, 0, 0.05);
        transform: translateX(5px);
      }

      .task-list .task-item:active {
        background-color: rgba(0, 0, 0, 0.1);
        transform: translateX(3px);
      }

      .task-list .task-item:last-child {
        margin-bottom: 0;
      }

      .task-form-module {
        flex: 1;
        overflow-y: auto;
        display: block;
        margin-bottom: 0;
      }

      /* 当显示任务列表时 */
      .show-task-list .task-list.module-container {
        display: block;
      }

      /* 当显示表单时 */
      .show-task-form .task-form-module {
        display: block;
      }

      .show-task-form .task-list.module-container {
        display: none;
      }

      .empty-state.module-container {
        flex-shrink: 0;
      }

      .fixed-tasks .task-categories {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }

      .fixed-tasks .task-category {
        margin-bottom: 0;
      }

      .fixed-tasks .category-items {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      /* 其他任务保持原有布局 */
      .custom-tasks .task-categories {
        display: block;
      }

      .custom-tasks .task-category {
        margin-bottom: 16px;
      }

      .silver-summary {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: #f5f5f5;
        border-radius: 4px;
        margin-bottom: 10px;
        color: #666;
      }

      .silver-amount-total {
        font-weight: 500;
        color: #ff4d4f;
        font-size: 16px;
      }

      .silver-icon {
        display: flex;
        align-items: center;
        gap: 4px;
        color: #666;
        padding-right: 10px;
      }

      .role-info-right {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex-shrink: 0;
        padding-left: 20px;
      }

      .role-info-left {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .role-info-left .role-name-container {
        min-height: 36px;
        height: auto;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .role-header-buttons {
        display: flex;
        gap: 8px;
      }

      .role-task-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      .module-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .module-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .module-header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* 允许输入框和文本域可以复制 */
      input, textarea {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }

      /* 登录对话框样式 */
      .login-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .login-container {
        background: white;
        padding: 24px;
        border-radius: 4px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .login-header {
        margin-bottom: 24px;
        text-align: center;
      }

      .login-header h2 {
        font-size: 24px;
        color: rgba(0, 0, 0, 0.85);
      }

      .login-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .login-form-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .login-form-item label {
        font-size: 14px;
        color: rgba(0, 0, 0, 0.85);
      }

      .login-form-item input {
        height: 40px;
        padding: 8px 12px;
        border: 1px solid #d9d9d9;
        border-radius: 2px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .login-form-item input:focus {
        border-color: #40a9ff;
        box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        outline: none;
      }

      .login-form-actions {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        margin-top: 24px;
      }

      .login-form-actions button {
        flex: 1;
      }
    </style>
    <script>
      // 禁止右键菜单
      document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
      });

      // 禁止键盘快捷键
      document.addEventListener('keydown', function(e) {
        // 禁止 Ctrl+C, Ctrl+V, Ctrl+X
        if (e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'x')) {
          e.preventDefault();
        }
      });
    </script>
  </head>

  <body>
    <div id="app" class="container">
      <!-- 登录对话框 -->
      <div class="login-modal" v-if="showLoginModal">
        <div class="login-container">
          <div class="login-header">
            <h2>登录</h2>
          </div>
          <div class="login-form">
            <div class="login-form-item">
              <label for="username">用户名</label>
              <input
                type="text"
                id="username"
                v-model="loginForm.username"
                placeholder="请输入用户名"
                @keyup.enter="handleLogin"
              />
            </div>
            <div class="login-form-item">
              <label for="password">密码</label>
              <input
                type="password"
                id="password"
                v-model="loginForm.password"
                placeholder="请输入密码"
                @keyup.enter="handleLogin"
              />
            </div>
            <div class="login-form-actions">
              <button class="btn btn-danger" @click="showLoginModal = false">取消</button>
              <button class="btn" @click="handleLogin">登录</button>
            </div>
          </div>
        </div>
      </div>
      <div class="title-container module-container">
        <div class="title-left">
          <h1>诛仙世界角色周任务记录</h1>
          <p>
            说明：数据存储在浏览器缓存中，清除浏览器缓存会导致数据丢失，请自行导出备份。
          </p>
        </div>
        <div class="title-right">
          <div class="reset-info">
            <p>
              下次重置时间：<span class="reset-time">{{ nextResetDate }}</span>
            </p>
            <p>
              距离重置还有：<span class="reset-days">{{ daysUntilReset }}天</span>
            </p>
          </div>
          <div class="btn-group">
            <button class="btn" @click="login" v-if="!isLoggedIn">登录同步</button>
            <!-- <button class="btn btn-danger" @click="logout" v-if="isLoggedIn">退出登录</button> -->
            <button class="btn" @click="openAddRoleForm" v-if="!showAddRoleForm">
              添加角色
            </button>
            <button class="btn btn-danger" @click="cancelAddRoleForm" v-if="showAddRoleForm">
              取消添加
            </button>
          </div>
          <div class="btn-group">
            <button class="btn" @click="exportData">导出数据</button>
            <button class="btn" @click="importData">导入数据</button>
          </div>
        </div>
      </div>

      <div
        v-if="showAddRoleForm"
        class="form-group module-container role-module"
      >
        <h3>添加新角色</h3>
        <div class="role-form-container">
          <div class="role-form-left">
            <div class="form-group-horizontal">
              <label for="roleName">角色名称</label>
              <div class="form-control-wrapper">
                <input
                  type="text"
                  id="roleName"
                  class="form-control"
                  v-model="newRole.name"
                  placeholder="请输入角色名称"
                />
              </div>
            </div>
            <div class="form-group">
              <label>选择职业</label>
              <div class="profession-selection">
                <div
                  v-for="prof in professions"
                  :key="prof.value"
                  class="profession-option"
                  :class="{ selected: newRole.profession === prof.value }"
                  @click="newRole.profession = prof.value"
                >
                  <span
                    class="profession-tag"
                    :class="getProfessionClass(prof.value)"
                    >{{ prof.value }}</span
                  >
                </div>
              </div>
            </div>
          </div>
          <div class="role-form-right">
            <div class="form-group-horizontal">
              <label for="roleDescription">角色描述</label>
              <div class="form-control-wrapper">
                <textarea
                  id="roleDescription"
                  class="form-control"
                  v-model="newRole.description"
                  placeholder="请输入角色描述 (可选)"
                  style="height: 100px"
                ></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group form-buttons">
          <button class="btn" @click="addRole">保存角色</button>
        </div>
      </div>

      <div class="role-section" v-if="roles.length > 0">
        <div
          class="role-list module-container role-module"
        >
          <div class="module-header">
            <h3 class="module-title">角色列表</h3>
          </div>
          <div class="silver-summary" v-if="roles.length > 0">
            <span class="silver-icon">💰总资产</span>
            <div class="silver-amount-total">
              {{ calculateTotalSilver() }}万两
            </div>
          </div>
          <div
            v-for="(role, index) in roles"
            :key="role.id"
            class="role-item"
            :class="{ active: currentRoleIndex === index }"
            @click="selectRole(index)"
          >
            <div class="role-name-container">
              <h2
                class="module-title"
              >
                {{ role.name }}
              </h2>
              <span
                v-if="role.profession"
                class="profession-tag"
                :class="getProfessionClass(role.profession)"
              >
                {{ role.profession }}
              </span>
            </div>
            <div v-if="role.silver > 0" class="silver-display">
              <span class="silver-icon">💰</span>
              <div class="silver-right">
                <span class="silver-amount">{{ role.silver }}</span>
                <span class="silver-unit">万两</span>
              </div>
            </div>
            <div class="role-progress-container">
              <div class="progress-bar role-progress-bar">
                <div
                  class="progress-value"
                  :class="{ 'completed': calculateProgress(role) === 100 }"
                  :style="{ width: calculateProgress(role) + '%' }"
                ></div>
              </div>
              <span
                class="role-progress-value"
                :class="{ 'completed-text': calculateProgress(role) === 100 }"
              >
                {{ calculateProgress(role) }}%
              </span>
            </div>
          </div>
        </div>

        <div
          class="role-content"
          :class="{ 'show-task-form': showAddTaskForm }"
          v-if="currentRole"
        >
          <div class="role-header module-container header-module">
            <div class="role-info-left">
              <div class="role-name-container">
                <h2
                  class="module-title"
                >
                  {{ currentRole.name }}
                </h2>
                <span
                  v-if="currentRole.profession"
                  class="profession-tag"
                  :class="getProfessionClass(currentRole.profession)"
                >
                  {{ currentRole.profession }}
                </span>
                <!-- <div
                  v-if="currentRole.description && currentRole.description.trim()"
                  class="role-description"
                  style="flex-basis: 100%;"
                >
                  {{ currentRole.description }}
                </div> -->
              </div>

              <div class="silver-display">
                <div class="silver-left">
                  <span class="silver-icon">💰背包银两</span>
                  <div class="silver-edit-container">
                    <input
                      type="number"
                      class="silver-edit-input"
                      v-model="silverEditValue"
                      min="0"
                      step="1"
                      @keyup.enter="updateSilver"
                    />
                    <span class="silver-unit">万两</span>
                    <button class="btn" @click="updateSilver">更新</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="role-info-right">
              <div class="role-header-buttons">
                <button v-if="!showEditRoleForm" class="btn btn-edit" @click="editRole">编辑角色</button>
                <button v-else class="btn btn-danger" @click="cancelEditRole">取消编辑</button>
                <button class="btn btn-danger" @click="deleteRole">
                  删除角色
                </button>
              </div>
            </div>
          </div>

          <div
            v-if="showEditRoleForm"
            class="form-group module-container role-module"
          >
            <h3 class="module-title">编辑角色</h3>
            <div class="role-form-container">
              <div class="role-form-left">
                <div class="form-group-horizontal">
                  <label for="editRoleName">角色名称</label>
                  <div class="form-control-wrapper">
                    <input
                      type="text"
                      id="editRoleName"
                      class="form-control"
                      v-model="editingRole.name"
                      placeholder="请输入角色名称"
                    />
                  </div>
                </div>
                <div class="form-group">
                  <label>选择职业</label>
                  <div class="profession-selection">
                    <div
                      v-for="prof in professions"
                      :key="prof.value"
                      class="profession-option"
                      :class="{ selected: editingRole.profession === prof.value }"
                      @click="editingRole.profession = prof.value"
                    >
                      <span
                        class="profession-tag"
                        :class="getProfessionClass(prof.value)"
                        >{{ prof.value }}</span
                      >
                    </div>
                  </div>
                </div>
              </div>
              <div class="role-form-right">
                <div class="form-group-horizontal">
                  <label for="editRoleDescription">角色描述</label>
                  <div class="form-control-wrapper">
                    <textarea
                      id="editRoleDescription"
                      class="form-control"
                      v-model="editingRole.description"
                      placeholder="请输入角色描述 (可选)"
                      style="height: 100px"
                    ></textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group form-buttons">
              <button class="btn btn-success" @click="saveEditedRole">
                保存修改
              </button>
            </div>
          </div>

          <div
            v-if="showAddTaskForm"
            class="form-group module-container task-form-module"
          >
            <div class="module-header">
              <div class="module-header-left">
                <h3 class="module-title">
                  {{ currentRole.tasks.length === 0 ? '添加任务' : '编辑任务' }}
                </h3>
              </div>
              <div class="module-header-right">
                <button class="btn btn-danger" @click="showAddTaskForm = false">
                  取消
                </button>
              </div>
            </div>

            <!-- 固定任务部分 -->
            <div
              class="form-group"
              v-if="!isEditingTask || (isEditingTask && newTask.category === 'custom')"
            >
              <div class="module-container category-module">
                <div class="module-header">
                  <div class="module-header-left">
                    <h4 class="module-title">固定任务</h4>
                  </div>
                  <div class="module-header-right">
                    <button class="btn" @click="addSelectedTasks">
                      添加固定任务
                    </button>
                  </div>
                </div>

                <div class="task-categories">
                  <div class="task-category module-container category-module">
                    <div class="category-header">
                      <h4 class="module-title">副本</h4>
                      <button
                        class="btn-sm"
                        @click="selectAllInCategory('dungeon')"
                      >
                        全选
                      </button>
                    </div>
                    <div class="category-items">
                      <!-- 优化后的副本显示方式 -->
                      <div class="dungeon-group">
                        <div class="dungeon-group-header">
                          <span class="dungeon-size small">5人副本</span>
                        </div>
                        <div class="dungeon-task-container">
                          <div
                            v-for="(task, index) in getDungeonsBySize(5)"
                            :key="'dungeon-5-'+index"
                            class="dungeon-task-item"
                            @click="task.selected = !task.selected"
                          >
                            <input
                              type="checkbox"
                              :id="'dungeon-5-'+index"
                              v-model="task.selected"
                              @click.stop
                            />
                            <div class="dungeon-task-content">
                              <span>{{ task.name }}</span>
                              <span class="dungeon-tag" :class="task.difficulty"
                                >{{ getDifficultyText(task.difficulty) }}</span
                              >
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="dungeon-group">
                        <div class="dungeon-group-header">
                          <span class="dungeon-size medium">10人副本</span>
                        </div>
                        <div class="dungeon-task-container">
                          <div
                            v-for="(task, index) in getDungeonsBySize(10)"
                            :key="'dungeon-10-'+index"
                            class="dungeon-task-item"
                            @click="task.selected = !task.selected"
                          >
                            <input
                              type="checkbox"
                              :id="'dungeon-10-'+index"
                              v-model="task.selected"
                              @click.stop
                            />
                            <div class="dungeon-task-content">
                              <span>{{ task.name }}</span>
                              <span class="dungeon-tag" :class="task.difficulty"
                                >{{ getDifficultyText(task.difficulty) }}</span
                              >
                            </div>
                          </div>
                        </div>
                      </div>

                      <div
                        class="dungeon-group"
                        v-if="getDungeonsBySize(20).length > 0"
                      >
                        <div class="dungeon-group-header">
                          <span class="dungeon-size large">20人副本</span>
                        </div>
                        <div class="dungeon-task-container">
                          <div
                            v-for="(task, index) in getDungeonsBySize(20)"
                            :key="'dungeon-20-'+index"
                            class="dungeon-task-item"
                            @click="task.selected = !task.selected"
                          >
                            <input
                              type="checkbox"
                              :id="'dungeon-20-'+index"
                              v-model="task.selected"
                              @click.stop
                            />
                            <div class="dungeon-task-content">
                              <span>{{ task.name }}</span>
                              <span class="dungeon-tag" :class="task.difficulty"
                                >{{ getDifficultyText(task.difficulty) }}</span
                              >
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="task-category module-container category-module">
                    <div class="category-header">
                      <h4 class="module-title">帮派</h4>
                      <button
                        class="btn-sm"
                        @click="selectAllInCategory('guild')"
                      >
                        全选
                      </button>
                    </div>
                    <div class="category-items">
                      <div
                        v-for="(task, index) in predefinedTasks.guild"
                        :key="'guild-'+index"
                        class="dungeon-task-item"
                        @click="task.selected = !task.selected"
                      >
                        <input
                          type="checkbox"
                          :id="'guild-'+index"
                          v-model="task.selected"
                          @click.stop
                        />
                        <div class="dungeon-task-content">
                          <span>{{ task.name }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="task-category module-container category-module">
                    <div class="category-header">
                      <h4 class="module-title">世界</h4>
                      <button
                        class="btn-sm"
                        @click="selectAllInCategory('world')"
                      >
                        全选
                      </button>
                    </div>
                    <div class="category-items">
                      <div
                        v-for="(task, index) in predefinedTasks.world"
                        :key="'world-'+index"
                        class="dungeon-task-item"
                        @click="task.selected = !task.selected"
                      >
                        <input
                          type="checkbox"
                          :id="'world-'+index"
                          v-model="task.selected"
                          @click.stop
                        />
                        <div class="dungeon-task-content">
                          <span>{{ task.name }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="task-category module-container category-module">
                    <div class="category-header">
                      <h4 class="module-title">其他</h4>
                      <button
                        class="btn-sm"
                        @click="selectAllInCategory('other')"
                      >
                        全选
                      </button>
                    </div>
                    <div class="category-items">
                      <div
                        v-for="(task, index) in predefinedTasks.other"
                        :key="'other-'+index"
                        class="dungeon-task-item"
                        @click="task.selected = !task.selected"
                      >
                        <input
                          type="checkbox"
                          :id="'other-'+index"
                          v-model="task.selected"
                          @click.stop
                        />
                        <div class="dungeon-task-content">
                          <span>{{ task.name }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="task-category module-container category-module">
                    <div class="category-header">
                      <h4 class="module-title">活力</h4>
                      <button
                        class="btn-sm"
                        @click="selectAllInCategory('vitality')"
                      >
                        全选
                      </button>
                    </div>
                    <div class="category-items">
                      <div
                        v-for="(task, index) in predefinedTasks.vitality"
                        :key="'vitality-'+index"
                        class="dungeon-task-item"
                        @click="task.selected = !task.selected"
                      >
                        <input
                          type="checkbox"
                          :id="'vitality-'+index"
                          v-model="task.selected"
                          @click.stop
                        />
                        <div class="dungeon-task-content">
                          <span>{{ task.name }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="task-category module-container category-module">
                    <div class="category-header">
                      <h4 class="module-title">限时</h4>
                      <button class="btn-sm" @click="selectAllInCategory('activity')">全选</button>
                    </div>
                    <div class="category-items">
                      <div v-for="(task, index) in predefinedTasks.activity" :key="'activity-'+index" class="dungeon-task-item" @click="task.selected = !task.selected">
                        <input type="checkbox" :id="'activity-'+index" v-model="task.selected" @click.stop />
                        <div class="dungeon-task-content">
                          <span>{{ task.name }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <!-- 自定义任务部分 -->
            <div class="form-group module-container category-module">
              <div class="module-header">
                <div class="module-header-left">  
                  <h4 class="module-title">自定义任务</h4>
                </div>
                <div class="module-header-right">
                  <button class="btn" @click="addTask">添加自定义任务</button>
                </div>
              </div>
              <div class="form-group-horizontal">
                <label for="taskName">任务名称</label>
                <div class="form-control-wrapper">
                  <input
                    type="text"
                    id="taskName"
                    class="form-control"
                    v-model="newTask.name"
                    placeholder="最多输入30个字符"
                    maxlength="30"
                  />
                </div>
              </div>
            </div>
          </div>

          <div
            class="task-list module-container task-list-module"
            v-if="currentRole.tasks.length > 0"
          >
            <div class="module-header">
              <div class="module-header-left">
                <h3 class="module-title">任务列表</h3>
              </div>
              <div class="module-header-right">
                <button class="btn btn-edit" @click="openAddTaskForm">
                  编辑任务
                </button>
              </div>
            </div>
            <div class="task-list-content">
              <div
                v-for="(task, index) in sortedTasks"
                :key="task.id"
                class="task-item"
                :class="{ 'completed': task.completed }"
                @click="toggleTaskStatus(getOriginalIndex(task))"
              >
                <div class="task-content">
                  <input
                    type="checkbox"
                    class="task-checkbox"
                    :checked="task.completed"
                    @click.stop="toggleTaskStatus(getOriginalIndex(task))"
                  />
                  <span class="task-type-tag" :class="task.category"
                    >{{ getCategoryText(task.category) }}</span
                  >
                  <span
                    v-if="!(task.category === 'custom' && task.isEditing)"
                    class="task-name"
                    >{{ task.name }}</span
                  >
                  <input
                    v-else
                    type="text"
                    class="form-control"
                    style="
                      width: auto;
                      min-width: 200px;
                      margin: 0 10px 0 0;
                      display: inline-block;
                    "
                    v-model="task.editName"
                    @keyup.enter="saveInlineEdit(getOriginalIndex(task))"
                    @keyup.esc="cancelInlineEdit(getOriginalIndex(task))"
                    @click.stop
                    ref="inlineEditInput"
                    maxlength="30"
                  />
                </div>
                <div class="task-actions">
                  <template
                    v-if="task.category === 'custom' && !task.isEditing"
                  >
                    <button
                      class="btn btn-edit"
                      @click.stop="startInlineEdit(getOriginalIndex(task))"
                    >
                      编辑
                    </button>
                  </template>
                  <button
                    v-if="!task.isEditing"
                    class="btn btn-danger"
                    @click.stop="deleteTask(getOriginalIndex(task))"
                  >
                    删除
                  </button>
                  <template v-if="task.isEditing">
                    <button
                      class="btn btn-success"
                      @click.stop="saveInlineEdit(getOriginalIndex(task))"
                    >
                      保存
                    </button>
                    <button
                      class="btn btn-danger"
                      @click.stop="cancelInlineEdit(getOriginalIndex(task))"
                    >
                      取消
                    </button>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <div
            v-else-if="!showAddTaskForm"
            class="empty-state module-container"
          >
            <button class="btn btn-edit" @click="openAddTaskForm">
              添加任务
            </button>
          </div>
        </div>

        <div class="role-content empty-state module-container" v-else>
          <p>请选择一个角色</p>
        </div>
      </div>

      <div class="empty-state module-container" v-else>
        <p>暂无角色，请添加新角色</p>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, watch, onMounted } = Vue;

      createApp({
        setup() {
          // 添加在 setup 函数开始处
          const debounce = (fn, delay) => {
            let timer = null;
            return function (...args) {
              if (timer) clearTimeout(timer);
              timer = setTimeout(() => {
                fn.apply(this, args);
              }, delay);
            };
          };
          
          // 添加登录相关的状态
          const isLoggedIn = ref(false);
          const token = ref('');
          const showLoginModal = ref(false);
          const loginForm = ref({
            username: '',
            password: ''
          });

          // 登录方法
          const login = () => {
            showLoginModal.value = true;
          };

          // 处理登录
          const handleLogin = async () => {
            if (!loginForm.value.username || !loginForm.value.password) {
              alert('请输入用户名和密码');
              return;
            }

            try {
              const response = await fetch('http://localhost:3000/api/auth/login', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  username: loginForm.value.username,
                  password: loginForm.value.password,
                }),
              });

              const data = await response.json();
              
              if (!response.ok) {
                alert(data.message || '登录失败，请重试');
                return;
              }

              token.value = data.token;
              isLoggedIn.value = true;
              localStorage.setItem('token', data.token);
              showLoginModal.value = false;
              loginForm.value = { username: '', password: '' };
              
              // 登录成功后立即从服务器获取数据
              await loadData();
              // 登录成功后立即同步当前数据到服务器（不使用防抖）
              if (roles.value.length > 0) {
                await fetch('http://localhost:3000/api/data/sync', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token.value}`
                  },
                  body: JSON.stringify({
                    roles: roles.value
                  })
                });
              }
              alert('登录成功！');
            } catch (error) {
              console.error('登录错误:', error);
              alert('登录失败，请检查网络连接');
            }
          };

          // 登出方法
          const logout = () => {
            token.value = '';
            isLoggedIn.value = false;
            localStorage.removeItem('token');
            // 登出后加载本地数据
            loadData();
          };

          // 检查登录状态
          const checkLoginStatus = () => {
            const savedToken = localStorage.getItem('token');
            if (savedToken) {
              token.value = savedToken;
              isLoggedIn.value = true;
            }
          };

          // 在组件挂载时检查登录状态
          onMounted(() => {
            checkLoginStatus();
            loadData();
            checkResetDay();
            // 每小时检查一次是否需要重置
            setInterval(checkResetDay, 60 * 60 * 1000);
          });

          // 数据
          const roles = ref([]);
          const currentRoleIndex = ref(-1);
          const showAddRoleForm = ref(false);
          const showAddTaskForm = ref(false);
          const showEditRoleForm = ref(false);
          const isEditingTask = ref(false);
          const editingTaskIndex = ref(-1);
          const newRole = ref({
            name: "",
            description: "",
            profession: "",
            silver: 0,
          });
          const editingRole = ref({
            name: "",
            description: "",
            profession: "",
            silver: 0,
          });
          const newTask = ref({ name: "" });
          const silverEditValue = ref(0);

          // 职业列表
          const professions = ref([
            { value: "鬼王", label: "鬼王", class: "ghost-king" },
            { value: "灵汐", label: "灵汐", class: "spirit-tide" },
            { value: "青云", label: "青云", class: "blue-cloud" },
            { value: "合欢", label: "合欢", class: "harmony" },
            { value: "焚香", label: "焚香", class: "incense" },
          ]);

          // 获取职业对应的CSS类
          const getProfessionClass = (profession) => {
            const found = professions.value.find((p) => p.value === profession);
            return found ? found.class : "";
          };

          // 预定义任务
          const predefinedTasks = ref({
            dungeon: [
              {
                name: "小本5连",
                size: 5,
                difficulty: "hard",
                displayName: "5人",
                selected: false,
              },
              {
                name: "大本6+1",
                size: 5,
                difficulty: "nightmare",
                displayName: "5人",
                selected: false,
              },
              {
                name: "云沙锁黄昏",
                size: 10,
                difficulty: "hard",
                displayName: "10人云沙锁黄昏",
                selected: false,
              },
              {
                name: "渡厄炼血堂",
                size: 10,
                difficulty: "hard",
                displayName: "10人渡厄炼血堂",
                selected: false,
              },
              {
                name: "幽劫死灵渊",
                size: 10,
                difficulty: "hard",
                displayName: "10人幽劫死灵渊",
                selected: false,
              },
              {
                name: "云沙锁黄昏",
                size: 20,
                difficulty: "hard",
                displayName: "20人云沙锁黄昏",
                selected: false,
              },
              {
                name: "渡厄炼血堂",
                size: 20,
                difficulty: "hard",
                displayName: "20人渡厄炼血堂",
                selected: false,
              },
              {
                name: "云沙锁黄昏",
                size: 10,
                difficulty: "nightmare",
                displayName: "10人云沙锁黄昏",
                selected: false,
              },
              {
                name: "渡厄炼血堂",
                size: 10,
                difficulty: "nightmare",
                displayName: "10人渡厄炼血堂",
                selected: false,
              },
              {
                name: "幽劫死灵渊",
                size: 10,
                difficulty: "nightmare",
                displayName: "10人幽劫死灵渊",
                selected: false,
              },
            ],
            guild: [
              { name: "帮战", selected: false },
              { name: "帮派周奖励", selected: false },
              { name: "帮派钓鱼", selected: false },
              { name: "帮派BOSS", selected: false },
            ],
            world: [
              { name: "世界BOSS", selected: false },
              { name: "邪枭任务", selected: false },
              { name: "风云任务", selected: false },
            ],
            other: [
              { name: "风华值周奖励", selected: false },
              { name: "北荒战云", selected: false },
              { name: "周活跃奖励", selected: false },
              { name: "璇玑宝库", selected: false },
            ],
            vitality: [
              { name: "活力消耗", selected: false },
              { name: "钓鱼", selected: false },
              { name: "烹饪", selected: false },
              { name: "炼药", selected: false },
              { name: "雕刻", selected: false },
              { name: "锻造", selected: false },
              { name: "缝纫", selected: false },
              { name: "挖矿", selected: false },
              { name: "采摘", selected: false },
            ],
            activity: [
              { name: "植树节活动", selected: false },
            ],
          });

          // 计算属性
          const currentRole = computed(() => {
            if (
              currentRoleIndex.value >= 0 &&
              currentRoleIndex.value < roles.value.length
            ) {
              return roles.value[currentRoleIndex.value];
            }
            return null;
          });

          // 排序后的任务列表（已完成的任务放在最后）
          const sortedTasks = computed(() => {
            if (!currentRole.value || !currentRole.value.tasks) return [];

            // 按照分类顺序排序：副本、帮派、世界、其他、活力、自定义
            const categoryOrder = {
              dungeon: 1,
              guild: 2,
              world: 3,
              other: 4,
              vitality: 5,
              activity: 6,
              custom: 7,
            };

            return [...currentRole.value.tasks].sort((a, b) => {
              // 首先按照完成状态排序（未完成的在前，已完成的在后）
              if (a.completed !== b.completed) {
                return a.completed ? 1 : -1;
              }

              // 然后按照分类顺序排序
              if (a.category !== b.category) {
                return categoryOrder[a.category] - categoryOrder[b.category];
              }

              // 如果是副本任务，按照人数和难度排序
              if (a.category === 'dungeon' && b.category === 'dungeon') {
                // 首先按人数排序
                if (a.originalTask.size !== b.originalTask.size) {
                  return a.originalTask.size - b.originalTask.size;
                }
                // 人数相同时，按难度排序（困难在前，噩梦在后）
                if (a.originalTask.difficulty !== b.originalTask.difficulty) {
                  return a.originalTask.difficulty === 'hard' ? -1 : 1;
                }
                // 难度相同时，按名称排序
                return a.name.localeCompare(b.name);
              }

              // 其他类型的任务按名称排序
              return a.name.localeCompare(b.name);
            });
          });

          // 按人数排序的副本任务
          const sortedDungeonTasks = computed(() => {
            return [...predefinedTasks.value.dungeon].sort((a, b) => {
              // 首先按人数排序
              if (a.size !== b.size) {
                return a.size - b.size;
              }
              // 人数相同时，按难度排序（困难在前，噩梦在后）
              if (a.difficulty !== b.difficulty) {
                return a.difficulty === "hard" ? -1 : 1;
              }
              // 难度相同时，按名称排序
              return a.name.localeCompare(b.name);
            });
          });

          // 下次重置日期计算
          const nextResetDate = computed(() => {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0是周日，3是周三
            const daysUntilWednesday = (3 - dayOfWeek + 7) % 7;
            const nextWednesday = new Date(now);
            nextWednesday.setDate(now.getDate() + daysUntilWednesday);
            nextWednesday.setHours(0, 0, 0, 0);

            return nextWednesday.toLocaleDateString("zh-CN");
          });

          const daysUntilReset = computed(() => {
            const now = new Date();
            const dayOfWeek = now.getDay();
            return (3 - dayOfWeek + 7) % 7 || 7; // 如果今天是周三，返回7
          });

          // 获取任务在原始数组中的索引
          const getOriginalIndex = (task) => {
            return currentRole.value.tasks.findIndex((t) => t.id === task.id);
          };

          // 方法
          const loadData = async () => {
            if (isLoggedIn.value) {
              try {
                const response = await fetch('http://localhost:3000/api/data/sync', {
                  headers: {
                    'Authorization': `Bearer ${token.value}`
                  }
                });
                const data = await response.json();
                
                if (response.ok) {
                  // 更新内存中的数据
                  roles.value = data.roles || [];
                  
                  localStorage.setItem('roleTaskManager', JSON.stringify(data.roles || []));
                  
                  // 更新当前选中的角色
                  if (roles.value.length > 0) {
                    currentRoleIndex.value = 0;
                    silverEditValue.value = roles.value[0].silver || 0;
                  }
                  
                  return;
                }
              } catch (error) {
                console.error('获取服务器数据失败:', error);
              }
            }
            
            // 如果未登录或获取服务器数据失败，使用本地存储的数据
            const savedRoles = localStorage.getItem('roleTaskManager');
            if (savedRoles) {
              roles.value = JSON.parse(savedRoles);
              if (roles.value.length > 0) {
                currentRoleIndex.value = 0;
                silverEditValue.value = roles.value[0].silver || 0;
              }
            }
          };

          // 创建一个防抖的同步函数
          const syncDataToServer = debounce(async () => {
            if (isLoggedIn.value) {
              try {
                const response = await fetch('http://localhost:3000/api/data/sync', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token.value}`
                  },
                  body: JSON.stringify({
                    roles: roles.value
                  })
                });
                
                if (!response.ok) {
                  console.error('同步到服务器失败');
                  if (response.status === 401) {
                    logout();
                    alert('登录已过期，请重新登录');
                  }
                }
              } catch (error) {
                console.error('同步数据失败:', error);
              }
            }
          }, 2000); // 2秒的防抖延迟

          // 修改 saveData 函数
          const saveData = () => {
            // 保存到本地存储
            localStorage.setItem('roleTaskManager', JSON.stringify(roles.value));
            
            // 使用防抖的同步函数
            syncDataToServer();
          };

          const openAddRoleForm = () => {
            showAddRoleForm.value = true;
            // 重置newRole的值
            newRole.value = {
              name: "",
              description: "",
              profession: "",
              silver: 0,
            };
          };

          const cancelAddRoleForm = () => {
            showAddRoleForm.value = false;
            // 重置newRole的值
            newRole.value = {
              name: "",
              description: "",
              profession: "",
              silver: 0,
            };
          };

          const addRole = () => {
            if (!newRole.value.name.trim()) {
              alert("角色名称不能为空");
              return;
            }

            const role = {
              id: Date.now(),
              name: newRole.value.name.trim(),
              description: newRole.value.description || "",
              profession: newRole.value.profession || "",
              silver: 0,
              tasks: [],
            };
            roles.value.push(role);
            currentRoleIndex.value = roles.value.length - 1;
            newRole.value = {
              name: "",
              description: "",
              profession: "",
              silver: 0,
            };
            showAddRoleForm.value = false;
            saveData();
          };

          const selectRole = (index) => {
            currentRoleIndex.value = index;

            // 初始化银两编辑值
            if (roles.value[index] && roles.value[index].silver !== undefined) {
              silverEditValue.value = roles.value[index].silver;
            } else {
              silverEditValue.value = 0;
            }

            // 切换角色时关闭任务表单
            showAddTaskForm.value = false;
            showEditRoleForm.value = false;
            isEditingTask.value = false;
            editingTaskIndex.value = -1;
            newTask.value = { name: "" };

            // 重置所有预定义任务的选中状态
            Object.keys(predefinedTasks.value).forEach((category) => {
              predefinedTasks.value[category].forEach((task) => {
                task.selected = false;
              });
            });
          };

          const deleteRole = () => {
            if (confirm(`确定要删除角色 "${currentRole.value.name}" 吗？`)) {
              roles.value.splice(currentRoleIndex.value, 1);
              if (roles.value.length > 0) {
                currentRoleIndex.value = 0;
              } else {
                currentRoleIndex.value = -1;
              }
              saveData();
            }
          };

          const addTask = () => {
            if (!newTask.value.name.trim()) {
              alert("任务名称不能为空");
              return;
            }

            // 如果是编辑模式，调用updateTask方法
            if (isEditingTask.value && editingTaskIndex.value >= 0) {
              updateTask();
              return;
            }

            const task = {
              id: Date.now(),
              name: newTask.value.name,
              completed: false,
              category: "custom",
              originalTask: { name: newTask.value.name },
            };

            currentRole.value.tasks.push(task);
            newTask.value = { name: "" };
            showAddTaskForm.value = false;
            saveData();
          };

          const openAddTaskForm = () => {
            showAddTaskForm.value = true;
            isEditingTask.value = true; // 修改为 true，表示进入编辑模式
            editingTaskIndex.value = -1;
            newTask.value = { name: "", category: "custom" };

            // 重置所有预定义任务的选中状态
            Object.keys(predefinedTasks.value).forEach((category) => {
              predefinedTasks.value[category].forEach((task) => {
                task.selected = false;
              });
            });

            // 如果当前角色已有任务，则反映之前选择的选项
            if (currentRole.value && currentRole.value.tasks.length > 0) {
              // 遍历当前角色的所有任务
              currentRole.value.tasks.forEach((roleTask) => {
                // 只处理非自定义任务
                if (roleTask.category !== "custom" && roleTask.originalTask) {
                  // 根据任务类别找到对应的预定义任务列表
                  const categoryTasks =
                    predefinedTasks.value[roleTask.category];
                  if (categoryTasks) {
                    // 对于副本任务，需要匹配名称、人数和难度
                    if (roleTask.category === "dungeon") {
                      const matchingTask = categoryTasks.find(
                        (task) =>
                          task.name === roleTask.originalTask.name &&
                          task.size === roleTask.originalTask.size &&
                          task.difficulty === roleTask.originalTask.difficulty
                      );
                      if (matchingTask) {
                        matchingTask.selected = true;
                      }
                    } else {
                      // 对于其他类型任务，只需匹配名称
                      const matchingTask = categoryTasks.find(
                        (task) => task.name === roleTask.originalTask.name
                      );
                      if (matchingTask) {
                        matchingTask.selected = true;
                      }
                    }
                  }
                }
              });
            }
          };

          const cancelTaskForm = () => {
            showAddTaskForm.value = false;
            isEditingTask.value = false;
            editingTaskIndex.value = -1;
            newTask.value = { name: "" };
          };

          const editTask = (taskIndex) => {
            const task = currentRole.value.tasks[taskIndex];

            // 如果不是自定义任务，则不允许编辑
            if (task.category !== "custom") {
              alert("固定任务不允许编辑");
              return;
            }

            // 设置编辑状态和索引
            isEditingTask.value = true;
            editingTaskIndex.value = taskIndex;
            showAddTaskForm.value = true;

            // 回显任务名称到输入框
            newTask.value = {
              name: task.name,
              originalTask: task.originalTask,
              category: task.category,
            };

            // 滚动到任务表单区域
            setTimeout(() => {
              const taskForm = document.querySelector(".task-form");
              if (taskForm) {
                taskForm.scrollIntoView({ behavior: "smooth" });
              }
            }, 100);
          };

          const updateTask = () => {
            if (!newTask.value.name.trim()) {
              alert("任务名称不能为空");
              return;
            }

            if (
              editingTaskIndex.value >= 0 &&
              editingTaskIndex.value < currentRole.value.tasks.length
            ) {
              // 更新任务名称，但保留其他属性
              const task = currentRole.value.tasks[editingTaskIndex.value];
              task.name = newTask.value.name;

              // 如果是自定义任务，同时更新originalTask
              if (task.category === "custom") {
                task.originalTask = { name: newTask.value.name };
              }

              saveData();
              showAddTaskForm.value = false;
              isEditingTask.value = false;
              editingTaskIndex.value = -1;
              newTask.value = { name: "" };
            }
          };

          // 添加选中的预定义任务
          const addSelectedTasks = () => {
            let hasSelectedTasks = false;

            // 如果是编辑模式，先删除取消勾选的固定任务
            if (isEditingTask.value) {
              // 创建一个映射，记录当前选中的固定任务
              const selectedTasksMap = {};

              Object.keys(predefinedTasks.value).forEach((category) => {
                if (category !== "custom") {
                  // 只处理固定任务
                  predefinedTasks.value[category].forEach((task) => {
                    if (task.selected) {
                      // 对于副本任务，使用名称+人数+难度作为键
                      if (category === "dungeon") {
                        const key = `${category}-${task.name}-${task.size}-${task.difficulty}`;
                        selectedTasksMap[key] = true;
                      } else {
                        // 对于其他任务，使用分类+名称作为键
                        const key = `${category}-${task.name}`;
                        selectedTasksMap[key] = true;
                      }
                    }
                  });
                }
              });

              // 过滤掉未选中的固定任务
              const filteredTasks = currentRole.value.tasks.filter((task) => {
                // 保留所有自定义任务
                if (task.category === "custom") {
                  return true;
                }

                // 检查固定任务是否在选中列表中
                if (task.originalTask) {
                  if (task.category === "dungeon") {
                    const key = `${task.category}-${task.originalTask.name}-${task.originalTask.size}-${task.originalTask.difficulty}`;
                    return selectedTasksMap[key];
                  } else {
                    const key = `${task.category}-${task.originalTask.name}`;
                    return selectedTasksMap[key];
                  }
                }

                return false; // 如果没有originalTask信息，不保留
              });

              // 明确地将过滤后的任务列表赋值给currentRole.value.tasks
              currentRole.value.tasks = filteredTasks;
            }

            // 遍历所有分类的任务
            Object.keys(predefinedTasks.value).forEach((category) => {
              predefinedTasks.value[category].forEach((task) => {
                if (task.selected) {
                  hasSelectedTasks = true;

                  // 检查任务是否已存在
                  let taskExists = false;
                  if (currentRole.value.tasks) {
                    taskExists = currentRole.value.tasks.some(
                      (existingTask) => {
                        if (
                          existingTask.category === category &&
                          existingTask.originalTask
                        ) {
                          if (category === "dungeon") {
                            return (
                              existingTask.originalTask.name === task.name &&
                              existingTask.originalTask.size === task.size &&
                              existingTask.originalTask.difficulty ===
                                task.difficulty
                            );
                          } else {
                            return existingTask.originalTask.name === task.name;
                          }
                        }
                        return false;
                      }
                    );
                  }

                  // 如果任务不存在，才添加
                  if (!taskExists) {
                    // 根据任务类型构建任务名称
                    let taskName = "";
                    if (category === "dungeon") {
                      // 副本类型的任务，使用格式化的名称
                      taskName = `${task.size}人${
                        task.name
                      }（${getDifficultyText(task.difficulty)}）`;
                    } else {
                      // 其他类型的任务，直接使用名称
                      taskName = task.name;
                    }

                    currentRole.value.tasks.push({
                      id: Date.now() + Math.random(),
                      name: taskName,
                      completed: false,
                      category: category,
                      originalTask:
                        category === "dungeon"
                          ? {
                              name: task.name,
                              size: task.size,
                              difficulty: task.difficulty,
                            }
                          : { name: task.name },
                    });
                  }
                  task.selected = false; // 重置选择状态
                }
              });
            });

            if (!hasSelectedTasks && !isEditingTask.value) {
              alert("请至少选择一个任务");
              return;
            }

            showAddTaskForm.value = false;
            isEditingTask.value = false;
            editingTaskIndex.value = -1;
            saveData();
          };

          // 全选某个分类的任务
          const selectAllInCategory = (category) => {
            const allSelected = predefinedTasks.value[category].every(
              (task) => task.selected
            );

            predefinedTasks.value[category].forEach((task) => {
              task.selected = !allSelected;
            });
          };

          // 获取副本人数对应的样式类
          const getSizeClass = (size) => {
            if (size === 5) return "small";
            if (size === 10) return "medium";
            if (size === 20) return "large";
            return "";
          };

          // 获取副本难度对应的文本
          const getDifficultyText = (difficulty) => {
            if (difficulty === "hard") return "困难";
            if (difficulty === "nightmare") return "噩梦";
            return "";
          };

          // 获取特定人数的副本
          const getDungeonsBySize = (size) => {
            return predefinedTasks.value.dungeon
              .filter((task) => task.size === size)
              .sort((a, b) => {
                // 先按难度排序（困难在前，噩梦在后）
                if (a.difficulty !== b.difficulty) {
                  return a.difficulty === "hard" ? -1 : 1;
                }
                // 难度相同时，按名称排序
                return a.name.localeCompare(b.name);
              });
          };

          const toggleTaskStatus = (taskIndex) => {
            const task = currentRole.value.tasks[taskIndex];
            task.completed = !task.completed;
            saveData();
          };

          const deleteTask = (taskIndex) => {
            currentRole.value.tasks.splice(taskIndex, 1);
            saveData();
          };

          // 行内编辑相关方法
          const startInlineEdit = (taskIndex) => {
            const task = currentRole.value.tasks[taskIndex];
            if (task.category !== "custom") {
              alert("固定任务不允许编辑");
              return;
            }

            // 设置编辑状态和临时编辑名称
            task.isEditing = true;
            task.editName = task.name;

            // 在下一个DOM更新周期后聚焦输入框
            setTimeout(() => {
              if (document.querySelector('.task-item input[type="text"]')) {
                document.querySelector('.task-item input[type="text"]').focus();
              }
            }, 50);
          };

          const saveInlineEdit = (taskIndex) => {
            const task = currentRole.value.tasks[taskIndex];

            if (!task.editName || !task.editName.trim()) {
              alert("任务名称不能为空");
              return;
            }

            // 更新任务名称
            task.name = task.editName.trim();

            // 如果是自定义任务，同时更新originalTask
            if (task.category === "custom") {
              task.originalTask = { name: task.name };
            }

            // 退出编辑模式
            task.isEditing = false;
            delete task.editName;

            saveData();
          };

          const cancelInlineEdit = (taskIndex) => {
            const task = currentRole.value.tasks[taskIndex];

            // 退出编辑模式，不保存更改
            task.isEditing = false;
            delete task.editName;
          };

          // 获取任务分类的显示文本
          const getCategoryText = (category) => {
            const categoryMap = {
              custom: "自定义",
              dungeon: "副本",
              guild: "帮派",
              world: "世界",
              other: "其他",
              vitality: "活力",
              activity: "限时",
            };
            return categoryMap[category] || category;
          };

          const calculateProgress = (role) => {
            if (!role || !role.tasks || role.tasks.length === 0) {
              return 0;
            }

            const completedTasks = role.tasks.filter(
              (task) => task.completed
            ).length;
            return Math.round((completedTasks / role.tasks.length) * 100);
          };

          const checkResetDay = () => {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const hours = now.getHours();

            // 检查是否是周三早上8点
            if (dayOfWeek === 3 && hours >= 8) {
              const lastResetDate = localStorage.getItem("lastResetDate");
              const today = now.toISOString().split('T')[0];

              // 如果今天还没有重置
              if (lastResetDate !== today) {
                // 重置所有任务
                roles.value.forEach((role) => {
                  if (role.tasks) {
                    role.tasks.forEach((task) => {
                      task.completed = false;
                    });
                  }
                });

                // 保存重置日期
                localStorage.setItem("lastResetDate", today);
                saveData();
                console.log("任务已重置");
              }
            }
          };

          const editRole = () => {
            showEditRoleForm.value = true;
            // 使用深拷贝来避免引用问题
            editingRole.value = {
              name: currentRole.value.name || "",
              description: currentRole.value.description || "",
              profession: currentRole.value.profession || "",
              silver: currentRole.value.silver || 0,
              tasks: [...(currentRole.value.tasks || [])],
            };
          };

          const saveEditedRole = () => {
            if (!editingRole.value.name.trim()) {
              alert("角色名称不能为空");
              return;
            }

            // 同步更新 roles 数组中的数据
            if (
              currentRoleIndex.value >= 0 &&
              currentRoleIndex.value < roles.value.length
            ) {
              roles.value[currentRoleIndex.value] = {
                ...roles.value[currentRoleIndex.value],
                name: editingRole.value.name.trim(),
                description: editingRole.value.description || "",
                profession: editingRole.value.profession || "",
                id: roles.value[currentRoleIndex.value].id,
                tasks: roles.value[currentRoleIndex.value].tasks,
              };

              // 保存数据并关闭编辑表单
              saveData();
              showEditRoleForm.value = false;
            }
          };

          const cancelEditRole = () => {
            showEditRoleForm.value = false;
          };

          // 添加更新银两的方法
          const updateSilver = () => {
            if (currentRole.value) {
              currentRole.value.silver = parseFloat(silverEditValue.value) || 0;
              saveData();
            }
          };

          // 导出数据
          const exportData = () => {
            const data = {
              roles: roles.value,
              lastResetDate: localStorage.getItem("lastResetDate")
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `role-task-manager-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          };

          // 导入数据
          const importData = () => {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = ".json";
            input.onchange = (e) => {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                  try {
                    const data = JSON.parse(e.target.result);
                    if (data.roles && Array.isArray(data.roles)) {
                      roles.value = data.roles;
                      if (data.lastResetDate) {
                        localStorage.setItem("lastResetDate", data.lastResetDate);
                      }
                      currentRoleIndex.value = roles.value.length > 0 ? 0 : -1;
                      saveData();
                      alert("数据导入成功！");
                    } else {
                      alert("无效的数据格式！");
                    }
                  } catch (error) {
                    console.error("导入数据时出错：", error);
                    alert("导入数据时出错，请确保文件格式正确！");
                  }
                };
                reader.readAsText(file);
              }
            };
            input.click();
          };

          // 监听数据变化
          watch(
            roles,
            () => {
              saveData();
            },
            { deep: true }
          );

          // 确保watch监听currentRole变化时更新银两值
          watch(currentRole, (newRole) => {
            if (newRole) {
              silverEditValue.value = newRole.silver || 0;
            }
          });

          // 计算总金额
          const calculateTotalSilver = () => {
            return roles.value.reduce(
              (total, role) => total + (role.silver || 0),
              0
            );
          };

          return {
            roles,
            currentRoleIndex,
            currentRole,
            showAddRoleForm,
            showAddTaskForm,
            showEditRoleForm,
            isEditingTask,
            newRole,
            editingRole,
            newTask,
            silverEditValue,
            updateSilver,
            predefinedTasks,
            sortedDungeonTasks,
            sortedTasks,
            nextResetDate,
            daysUntilReset,
            selectRole,
            addRole,
            deleteRole,
            addTask,
            addSelectedTasks,
            selectAllInCategory,
            getSizeClass,
            getDifficultyText,
            getDungeonsBySize,
            toggleTaskStatus,
            deleteTask,
            calculateProgress,
            openAddTaskForm,
            editTask,
            updateTask,
            cancelTaskForm,
            startInlineEdit,
            saveInlineEdit,
            cancelInlineEdit,
            getCategoryText,
            editRole,
            saveEditedRole,
            cancelEditRole,
            getOriginalIndex,
            professions,
            getProfessionClass,
            openAddRoleForm,
            cancelAddRoleForm,
            calculateTotalSilver,
            exportData,
            importData,
            // 添加新的返回值
            isLoggedIn,
            login,
            logout,
            showLoginModal,
            loginForm,
            handleLogin,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
